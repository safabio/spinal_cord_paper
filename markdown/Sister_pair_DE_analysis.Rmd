---
title: "Sister pair DE analysis of neuron clusters"
author: "Fabio Sacher"
date: "12.09.2023"
data:
output:
  html_document:
    df_print: paged
    toc: TRUE
    toc_float: TRUE
  html_notebook:
    fig_height: 7
    fig_width: 8
editor_options:
  chunk_output_type: inline
---

# General

```{r libraries, warning = FALSE, message=FALSE}
library(Seurat)
library(ggplot2)
library(magrittr)
library(dplyr)
library(tibble)
library(stringr)
library(modplots)
```

```{r}
broad_order <- c("progenitors",
      "FP",
      "RP",
      "FP/RP",
      "neurons",
      "OPC",
      "MFOL",
      "pericytes",
      "microglia",
      "blood",
      "vasculature"
      )

```

# Ctrl vs Lumbar

```{r path-list-lumb}
se_path <- c("Gg_ctrl_int_seurat_250723",
             "Gg_lumb_int_seurat_250723")

int_path <- "Gg_ctrl_lumb_int_seurat_250723"


```



```{r}

my.meta <- list()
annot <- list()
for (i in seq(se_path)) {
  # load the data sets
  my.se <- readRDS(paste0("~/spinal_cord_paper/data/", se_path[i], ".rds"))
  annot[[i]] <- read.csv(list.files("~/spinal_cord_paper/annotations",
                               pattern = str_remove(se_path[i], "_seurat_\\d{6}"),
                               full.names = TRUE))
  
  if(length(table(annot[[i]]$number)) != length(table(my.se$seurat_clusters))) {
     stop("Number of clusters must be identical!")
  }
  
  # rename for left join
  annot[[i]] <- annot[[i]] %>% 
    mutate(fine = paste(fine, number, sep = "_")) %>% 
    mutate(number = factor(number, levels = 1:nrow(annot[[i]]))) %>% 
    rename(seurat_clusters = number)
  
  ord_levels <- annot[[i]]$fine[order(match(annot[[i]]$broad, broad_order))]
   
  # add cluster annotation to meta data
  my.meta[[i]] <- my.se@meta.data %>% 
    rownames_to_column("rowname") %>% 
    left_join(annot[[i]], by = "seurat_clusters") %>% 
    mutate(fine = factor(fine, levels = ord_levels)) %>% 
    mutate(seurat_clusters = factor(seurat_clusters, levels = str_extract(ord_levels, "\\d{1,2}$"))) %>% 
    column_to_rownames("rowname")
}

rm(my.se)

```

```{r integrated-data-lumb}
  
my.se <- readRDS(paste0("~/spinal_cord_paper/data/", int_path, ".rds"))
  annot_int <- read.csv(list.files("~/spinal_cord_paper/annotations",
                               pattern = str_remove(int_path, "_seurat_\\d{6}"),
                               full.names = TRUE))
  
  if(length(table(annot_int$number)) != length(table(my.se$seurat_clusters))) {
     stop("Number of clusters must be identical!")
  }
  
  # rename for left join
  annot_int <- annot_int %>% 
    mutate(fine = paste(fine, number, sep = "_")) %>% 
    mutate(number = factor(number, levels = 1:nrow(annot_int))) %>% 
    rename(seurat_clusters = number)
  
  ord_levels <- annot_int$fine[order(match(annot_int$broad, broad_order))]
   
  # add cluster annotation to meta data
  my.se@meta.data <- my.se@meta.data %>% 
    rownames_to_column("rowname") %>% 
    left_join(annot_int, by = "seurat_clusters") %>% 
    mutate(fine = factor(fine, levels = ord_levels)) %>% 
    mutate(seurat_clusters = factor(seurat_clusters, levels = str_extract(ord_levels, "\\d{1,2}$"))) %>% 
    column_to_rownames("rowname")
  
```

## Dimplot

```{r cluster-annotations-lumb}

clust_col <- read.csv("~/spinal_cord_paper/annotations/broad_cluster_marker_colors.csv")

broad_cols <- clust_col %>% 
    filter(broad_cluster %in% annot_int$broad) %>% 
    pull(color)


DimPlot(my.se, reduction = "tsne", group.by = "broad", label = TRUE, pt.size = 0.5, cols = broad_cols)

```

## transfer cluster labels

The cell IDs of the poly samples got the appendices _3 and _4. Therefore the labels from the previous integration of poly 1 and 2 get switched to 3 and 4, so the cluster annotations can be transfered.

```{r}
table(stringi::stri_sub(rownames(my.meta[[1]]), -2,-1))
table(stringi::stri_sub(rownames(my.meta[[2]]), -2,-1))
table(stringi::stri_sub(rownames(my.se@meta.data), -2,-1))

my.meta[[2]] <- my.meta[[2]] %>%
  tibble::rownames_to_column("cell_ID") %>%
  dplyr::mutate(cell_ID = str_replace(cell_ID, "_1", "_3")) %>%
  dplyr::mutate(cell_ID = str_replace(cell_ID, "_2", "_4") ) %>%
  tibble::column_to_rownames("cell_ID")

identical(c(rownames(my.meta[[1]]), rownames(my.meta[[2]])), rownames(my.se@meta.data))

cell_annot <- rbind(my.meta[[1]], my.meta[[2]]) %>%
  dplyr::mutate(sample = substr(orig.ident, 4, 7)) %>%
  dplyr::mutate(annot_sample = paste(fine, sample, sep = "_")) %>%
  dplyr::mutate(broad_sample = paste(broad, sample, sep = "_"))

my.se <- AddMetaData(my.se, cell_annot[, c("sample","annot_sample", "broad_sample")]) 
```

```{r}
brach_poly_combined_labels <- cell_annot[, c("sample","annot_sample", "broad_sample")]

saveRDS(brach_poly_combined_labels, file = "~/spinal_cord_paper/annotations/ctrl_lumb_int_combined_labels.rds")
```

```{r fig.width=30, fig.height=10}

p1 <- DimPlot(
  my.se,
  group.by = "annot_sample",
  reduction = "tsne",
  label = TRUE,
  repel = TRUE
  ) +
  NoLegend()

p2 <- DimPlot(
  my.se,
  group.by = "annot_sample",
  reduction = "tsne",
  label = FALSE,
  split.by = "sample",
  repel = TRUE
  ) +
  NoLegend()

p3 <- DimPlot(
  my.se,
  group.by = "broad_sample",
  reduction = "tsne",
  label = TRUE,
  repel = TRUE
  )

p1 + p2 + p3

```
## Sister Pair DE

Here we run DE analasys between terminal sister pairs of different origin from the heatmap in spinal_cord_paper/markdown/heatmap_spearman_ctrl_lumb_poly_int.html.

```{r}
# sister pairs
sis_pairs <- data.frame(
  "ctrl" = c(16, 6, 20, 11, 8),
  "lumb" = c(24, 20, 20, 15, 15)
) 

# cell type annotations
sis_ctrl <- annot[[1]][sis_pairs$ctrl,] %>%
  droplevels() %>%
  mutate(fine = paste0(fine, "_ctrl"))
sis_lumb <- annot[[2]][sis_pairs$lumb,] %>%
  droplevels() %>%
  mutate(fine = paste0(fine, "_lumb"))


sis_annot <- cbind(sis_ctrl, sis_lumb) %>% tibble::remove_rownames()
colnames(sis_annot) <- paste0(c(rep("ctrl_",3),rep("lumb_",3)),
                             colnames(sis_annot))

sis_annot
```

```{r, message=FALSE}
Idents(my.se) <- "annot_sample"

sis_markers <- list()

for (i in seq(nrow(sis_annot))) {
  sis_markers[[i]] <- FindMarkers(
    my.se,
    ident.1 = sis_annot[i, "ctrl_fine"],
    ident.2 = sis_annot[i, "lumb_fine"],
    assay = "RNA",
    verbose = FALSE,
    only.pos = FALSE,
    min.pct = 0.25,
    logfc.threshold =  0.25,
    latent.vars = c("CC.Difference.seurat"),
    test.use = "MAST"
  ) %>%
    tibble::rownames_to_column("Gene.stable.ID") %>%
    dplyr::left_join(gnames, by = "Gene.stable.ID") %>%
    dplyr::arrange(-avg_log2FC) %>%
    dplyr::filter(p_val_adj < 0.05) %>%
    dplyr::filter(abs(avg_log2FC) > 0.5) %>%
  dplyr::mutate(delta_pct = pct.1 - pct.2)
}

names(sis_markers) <- paste0(sis_annot$ctrl_fine, "-vs-", sis_annot$lumb_fine)

saveRDS(sis_markers, file = "~/spinal_cord_paper/data/Gg_ctrl_lumb_sis_markers.rds")
```

# Ctrl vs Poly

```{r path-list-poly}
se_path <- c("Gg_ctrl_int_seurat_250723",
             "Gg_poly_int_seurat_250723")

int_path <- "Gg_ctrl_poly_int_seurat_250723"


```



```{r}

my.meta <- list()
annot <- list()
for (i in seq(se_path)) {
  # load the data sets
  my.se <- readRDS(paste0("~/spinal_cord_paper/data/", se_path[i], ".rds"))
  annot[[i]] <- read.csv(list.files("~/spinal_cord_paper/annotations",
                               pattern = str_remove(se_path[i], "_seurat_\\d{6}"),
                               full.names = TRUE))
  
  if(length(table(annot[[i]]$number)) != length(table(my.se$seurat_clusters))) {
     stop("Number of clusters must be identical!")
  }
  
  # rename for left join
  annot[[i]] <- annot[[i]] %>% 
    mutate(fine = paste(fine, number, sep = "_")) %>% 
    mutate(number = factor(number, levels = 1:nrow(annot[[i]]))) %>% 
    rename(seurat_clusters = number)
  
  ord_levels <- annot[[i]]$fine[order(match(annot[[i]]$broad, broad_order))]
   
  # add cluster annotation to meta data
  my.meta[[i]] <- my.se@meta.data %>% 
    rownames_to_column("rowname") %>% 
    left_join(annot[[i]], by = "seurat_clusters") %>% 
    mutate(fine = factor(fine, levels = ord_levels)) %>% 
    mutate(seurat_clusters = factor(seurat_clusters, levels = str_extract(ord_levels, "\\d{1,2}$"))) %>% 
    column_to_rownames("rowname")
}

rm(my.se)

```

```{r integrated-data-poly}
  
my.se <- readRDS(paste0("~/spinal_cord_paper/data/", int_path, ".rds"))
  annot_int <- read.csv(list.files("~/spinal_cord_paper/annotations",
                               pattern = str_remove(int_path, "_seurat_\\d{6}"),
                               full.names = TRUE))
  
  if(length(table(annot_int$number)) != length(table(my.se$seurat_clusters))) {
     stop("Number of clusters must be identical!")
  }
  
  # rename for left join
  annot_int <- annot_int %>% 
    mutate(fine = paste(fine, number, sep = "_")) %>% 
    mutate(number = factor(number, levels = 1:nrow(annot_int))) %>% 
    rename(seurat_clusters = number)
  
  ord_levels <- annot_int$fine[order(match(annot_int$broad, broad_order))]
   
  # add cluster annotation to meta data
  my.se@meta.data <- my.se@meta.data %>% 
    rownames_to_column("rowname") %>% 
    left_join(annot_int, by = "seurat_clusters") %>% 
    mutate(fine = factor(fine, levels = ord_levels)) %>% 
    mutate(seurat_clusters = factor(seurat_clusters, levels = str_extract(ord_levels, "\\d{1,2}$"))) %>% 
    column_to_rownames("rowname")
  
```

## Dimplot

```{r cluster-annotations-poly}

broad_cols <- clust_col %>% 
    filter(broad_cluster %in% annot_int$broad) %>% 
    pull(color)


DimPlot(my.se, reduction = "tsne", group.by = "broad", label = TRUE, pt.size = 0.5, cols = broad_cols)

```

## transfer cluster labels

The cell IDs of the poly samples got the appendices _3 and _4. Therefore the labels from the previous integration of poly 1 and 2 get switched to 3 and 4, so the cluster annotations can be transfered.

```{r}
table(stringi::stri_sub(rownames(my.meta[[1]]), -2,-1))
table(stringi::stri_sub(rownames(my.meta[[2]]), -2,-1))
table(stringi::stri_sub(rownames(my.se@meta.data), -2,-1))

my.meta[[2]] <- my.meta[[2]] %>%
  tibble::rownames_to_column("cell_ID") %>%
  dplyr::mutate(cell_ID = str_replace(cell_ID, "_1", "_3")) %>%
  dplyr::mutate(cell_ID = str_replace(cell_ID, "_2", "_4") ) %>%
  tibble::column_to_rownames("cell_ID")

identical(c(rownames(my.meta[[1]]), rownames(my.meta[[2]])), rownames(my.se@meta.data))

cell_annot <- rbind(my.meta[[1]], my.meta[[2]]) %>%
  dplyr::mutate(sample = substr(orig.ident, 4, 7)) %>%
  dplyr::mutate(annot_sample = paste(fine, sample, sep = "_")) %>%
  dplyr::mutate(broad_sample = paste(broad, sample, sep = "_"))

my.se <- AddMetaData(my.se, cell_annot[, c("sample","annot_sample", "broad_sample")]) 
```

```{r}
brach_poly_combined_labels <- cell_annot[, c("sample","annot_sample", "broad_sample")]

saveRDS(brach_poly_combined_labels, file = "~/spinal_cord_paper/annotations/ctrl_poly_int_combined_labels.rds")
```

```{r fig.width=30, fig.height=10}

p1 <- DimPlot(
  my.se,
  group.by = "annot_sample",
  reduction = "tsne",
  label = TRUE,
  repel = TRUE
  ) +
  NoLegend()

p2 <- DimPlot(
  my.se,
  group.by = "annot_sample",
  reduction = "tsne",
  label = FALSE,
  split.by = "sample",
  repel = TRUE
  ) +
  NoLegend()

p3 <- DimPlot(
  my.se,
  group.by = "broad_sample",
  reduction = "tsne",
  label = TRUE,
  repel = TRUE
  )

p1 + p2 + p3

```
## Sister Pair DE

Here we run DE analasys between terminal sister pairs of different origin from the heatmap in spinal_cord_paper/markdown/heatmap_spearman_ctrl_lumb_poly_int.html.

```{r}
# sister pairs
sis_pairs <- data.frame(
  "ctrl" = c(16, 16, 20, 11, 8, 6),
  "poly" = c(14, 26, 22, 15, 15, 6)
) 

# cell type annotations
sis_ctrl <- annot[[1]][sis_pairs$ctrl,] %>%
  droplevels() %>%
  mutate(fine = paste0(fine, "_ctrl"))
sis_poly <- annot[[2]][sis_pairs$poly,] %>%
  droplevels() %>%
  mutate(fine = paste0(fine, "_poly"))


sis_annot <- cbind(sis_ctrl, sis_poly) %>% tibble::remove_rownames()
colnames(sis_annot) <- paste0(c(rep("ctrl_",3),rep("poly_",3)),
                             colnames(sis_annot))

sis_annot
```

```{r, message=FALSE}
Idents(my.se) <- "annot_sample"

sis_markers <- list()

for (i in seq(nrow(sis_annot))) {
  sis_markers[[i]] <- FindMarkers(
    my.se,
    ident.1 = sis_annot[i, "ctrl_fine"],
    ident.2 = sis_annot[i, "poly_fine"],
    assay = "RNA",
    verbose = FALSE,
    only.pos = FALSE,
    min.pct = 0.25,
    logfc.threshold =  0.25,
    latent.vars = c("CC.Difference.seurat"),
    test.use = "MAST"
  ) %>%
    tibble::rownames_to_column("Gene.stable.ID") %>%
    dplyr::left_join(gnames, by = "Gene.stable.ID") %>%
    dplyr::arrange(-avg_log2FC) %>%
    dplyr::filter(p_val_adj < 0.05) %>%
    dplyr::filter(abs(avg_log2FC) > 0.5) %>%
  dplyr::mutate(delta_pct = pct.1 - pct.2)
}

names(sis_markers) <- paste0(sis_annot$ctrl_fine, "-vs-", sis_annot$poly_fine)

saveRDS(sis_markers, file = "~/spinal_cord_paper/data/Gg_ctrl_poly_sis_markers.rds")
```

```{r}
# Date and time of Rendering
Sys.time()

sessionInfo()
```